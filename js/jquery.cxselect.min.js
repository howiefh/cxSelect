/*!
 * jQuery cxSelect
 * @name jquery.cxselect.js
 * @version 1.4.2
 * @date 2017-09-26
 * @author ciaoca
 * @email ciaoca@gmail.com
 * @site https://github.com/ciaoca/cxSelect
 * @license Released under the MIT license
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(window.jQuery||window.Zepto||window.$)}(function(t){var e=function(){for(var s,a,i,n=0,r=arguments.length;n<r;n++)e.isJquery(arguments[n])||e.isZepto(arguments[n])?s=arguments[n]:e.isElement(arguments[n])?s=t(arguments[n]):"function"==typeof arguments[n]?i=arguments[n]:"object"==typeof arguments[n]&&(a=arguments[n]);var l=new e.init(s,a);return"function"==typeof i&&i(l),l};e.isElement=function(t){return!(!t||"function"!=typeof HTMLElement&&"object"!=typeof HTMLElement||!(t instanceof HTMLElement))||!(!t||!t.nodeType||1!==t.nodeType)},e.isJquery=function(t){return!!(t&&t.length&&("function"==typeof jQuery||"object"==typeof jQuery)&&t instanceof jQuery)},e.isZepto=function(t){return!(!t||!t.length||"function"!=typeof Zepto&&"object"!=typeof Zepto||!Zepto.zepto.isZ(t))},e.getIndex=function(t,e){return e?t:t-1},e.getData=function(t,e){if("string"==typeof e&&e.length)for(var s=0,a=(e=e.split(".")).length;s<a;s++)t=t[e[s]];return t},e.init=function(s,a){if(e.isJquery(s)||e.isZepto(s)){var i={dom:{box:s}};this.attach=e.attach.bind(i),this.detach=e.detach.bind(i),this.setOptions=e.setOptions.bind(i),this.clear=e.clear.bind(i),i.changeEvent=function(){e.selectChange.call(i,this.className)},i.settings=t.extend({},t.cxSelect.defaults,a,{url:i.dom.box.data("url"),emptyStyle:i.dom.box.data("emptyStyle"),required:i.dom.box.data("required"),firstTitle:i.dom.box.data("firstTitle"),firstValue:i.dom.box.data("firstValue"),jsonSpace:i.dom.box.data("jsonSpace"),jsonName:i.dom.box.data("jsonName"),jsonValue:i.dom.box.data("jsonValue"),jsonSub:i.dom.box.data("jsonSub")});var n=i.dom.box.data("selects");"string"==typeof n&&n.length&&(i.settings.selects=n.split(",")),this.setOptions(),this.attach(),i.settings.url||i.settings.data?t.isArray(i.settings.data)?e.start.call(i,i.settings.data):"string"==typeof i.settings.url&&i.settings.url.length&&t.getJSON(i.settings.url,function(t){e.start.call(i,t)}):e.start.apply(i)}},e.setOptions=function(s){var a=this;if(s&&t.extend(a.settings,s),(!t.isArray(a.selectArray)||!a.selectArray.length||s&&s.selects)&&(a.selectArray=[],t.isArray(a.settings.selects)&&a.settings.selects.length))for(var i,n=0,r=a.settings.selects.length;n<r&&((i=a.dom.box.find("select."+a.settings.selects[n]))&&i.length);n++)a.selectArray.push(i);s&&(!t.isArray(s.data)&&"string"==typeof s.url&&s.url.length?t.getJSON(a.settings.url,function(t){e.start.call(a,t)}):e.start.call(a,s.data))},e.attach=function(){this.attachStatus||this.dom.box.on("change","select",this.changeEvent),"boolean"==typeof this.attachStatus&&e.start.call(this),this.attachStatus=!0},e.detach=function(){this.dom.box.off("change","select",this.changeEvent),this.attachStatus=!1},e.clear=function(t){for(var e={display:"",visibility:""},s=t=isNaN(t)?0:t,a=this.selectArray.length;s<a;s++)this.selectArray[s].empty().prop("disabled",!0),"none"===this.settings.emptyStyle?e.display="none":"hidden"===this.settings.emptyStyle&&(e.visibility="hidden"),this.selectArray[s].css(e)},e.start=function(s){if(t.isArray(s)&&(this.settings.data=e.getData(s,this.settings.jsonSpace)),this.selectArray.length){for(var a=0,i=this.selectArray.length;a<i;a++)"string"!=typeof this.selectArray[a].attr("data-value")&&this.selectArray[a][0].options.length&&this.selectArray[a].attr("data-value",this.selectArray[a].val());this.settings.data||"string"==typeof this.selectArray[0].data("url")&&this.selectArray[0].data("url").length?e.getOptionData.call(this,0):this.selectArray[0][0].options.length&&"string"==typeof this.selectArray[0].attr("data-value")&&this.selectArray[0].attr("data-value").length?(this.selectArray[0].val(this.selectArray[0].attr("data-value")),e.getOptionData.call(this,1)):this.selectArray[0].prop("disabled",!1).css({display:"",visibility:""})}},e.getOptionData=function(s){var a=this;if(!("number"!=typeof s||isNaN(s)||s<0||s>=a.selectArray.length)){var i,n,r,l,o,c=a.selectArray[s],d=c.data("url"),u=void 0===c.data("jsonSpace")?a.settings.jsonSpace:c.data("jsonSpace"),g={};if(e.clear.call(a,s),"string"==typeof d&&d.length){if(s>0)for(var h=0,f=1;h<s;h++,f++)r=a.selectArray[f].data("queryName"),l=a.selectArray[h].attr("name"),o=a.selectArray[h].val(),"string"==typeof r&&r.length?g[r]=o:"string"==typeof l&&l.length&&(g[l]=o);t.getJSON(d,g,function(t){i=e.getData(t,u),e.buildOption.call(a,s,i)})}else if(a.settings.data&&"object"==typeof a.settings.data){i=a.settings.data;for(h=0;h<s;h++){if(n=e.getIndex(a.selectArray[h][0].selectedIndex,"boolean"==typeof a.selectArray[h].data("required")?a.selectArray[h].data("required"):a.settings.required),"object"!=typeof i[n]||!t.isArray(i[n][a.settings.jsonSub])||!i[n][a.settings.jsonSub].length){i=null;break}i=i[n][a.settings.jsonSub]}e.buildOption.call(a,s,i)}}},e.buildOption=function(e,s){var a=this.selectArray[e],i="boolean"==typeof a.data("required")?a.data("required"):this.settings.required,n=void 0===a.data("firstTitle")?this.settings.firstTitle:a.data("firstTitle"),r=void 0===a.data("firstValue")?this.settings.firstValue:a.data("firstValue"),l=void 0===a.data("jsonName")?this.settings.jsonName:a.data("jsonName"),o=void 0===a.data("jsonValue")?this.settings.jsonValue:a.data("jsonValue");if(t.isArray(s)){var c=i?"":'<option value="'+String(r)+'">'+String(n)+"</option>";if("string"==typeof l&&l.length){"string"==typeof o&&o.length||(o=l);for(var d=0,u=s.length;d<u;d++)c+='<option value="'+String(s[d][o])+'">'+String(s[d][l])+"</option>"}else for(d=0,u=s.length;d<u;d++)c+='<option value="'+String(s[d])+'">'+String(s[d])+"</option>";a.html(c).prop("disabled",!1).css({display:"",visibility:""}),this.dom.box.trigger("change_options",{index:e,select:a,data:s}),"string"==typeof a.attr("data-value")&&(a.val(String(a.attr("data-value"))).removeAttr("data-value"),a[0].selectedIndex<0&&(a[0].options[0].selected=!0)),(i||a[0].selectedIndex>0)&&a.trigger("change")}},e.selectChange=function(t){if("string"==typeof t&&t.length){var s;t=","+(t=t.replace(/\s+/g,","))+",";for(var a=0,i=this.selectArray.length;a<i;a++)if(t.indexOf(","+this.settings.selects[a]+",")>-1){s=a;break}"number"==typeof s&&s>-1&&(s+=1,e.getOptionData.call(this,s))}},t.cxSelect=function(){return e.apply(this,arguments)},t.cxSelect.defaults={selects:[],url:null,data:null,emptyStyle:null,required:!1,firstTitle:"请选择",firstValue:"",jsonSpace:"",jsonName:"n",jsonValue:"",jsonSub:"s"},t.fn.cxSelect=function(e,s){return this.each(function(a){t.cxSelect(this,e,s)}),this}});